#!/usr/bin/env bash

# Fail fast and make pipelines fail on first failing command
set -euo pipefail

# Enable jemalloc for reduced memory usage and latency.
if [ -z "${LD_PRELOAD+x}" ]; then
  LD_PRELOAD=$(find /usr/lib -name libjemalloc.so.2 -print -quit)
  export LD_PRELOAD
fi

# If running the rails server then create or migrate existing database
if [[ "${*}" == *"rails server"* ]] || [[ "${*}" == *"./bin/rails server"* ]]; then
  echo "Setting up database..."
  
  # Create database if it doesn't exist
  ./bin/rails db:create || true
  
  # Run all migrations
  ./bin/rails db:migrate
  
  # Check if courses table exists and has data
  course_count=$(./bin/rails runner "begin; puts Course.count; rescue; puts '0'; end" 2>/dev/null || echo '0')
  
  if [ "$course_count" = "0" ]; then
    echo "Seeding database..."
    ./bin/rails db:seed
  fi
  
  echo "Database setup complete."
fi

exec "${@}"
